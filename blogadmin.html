<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blog Admin Panel</title>
<style>
/* --- styles remain unchanged (same as before) --- */
</style>
</head>
<body>

<!-- Login -->
<div id="loginCard">
  <div class="login-card">
    <h2>Admin Login</h2>
    <div class="error" id="errorMsg"></div>
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- Admin Panel -->
<div id="adminPanel">
  <h1>Blog Admin Panel</h1>
  <form id="blogForm">
    <h2 class="formTitle" id="formTitle">Add New Blog</h2>
    <input type="text" id="title" name="title" placeholder="Blog Title" required>
    <input type="text" id="author" name="author" placeholder="Author Name" required>
    <input type="date" id="date" name="date" required>
    <input type="text" id="image" name="image" placeholder="Image URL" required>
    <textarea id="summary" name="summary" placeholder="Short Summary"></textarea>
    <textarea id="content" name="content" placeholder="Full Content"></textarea>
    <div style="display:flex; flex-wrap:wrap;">
      <button type="submit" id="submitBtn">Add Blog</button>
      <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
    </div>
  </form>

  <h2>All Blogs</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Author</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="blogAdminTable"></tbody>
    </table>
  </div>

  <div class="pagination" id="pagination"></div>
</div>

<!-- TinyMCE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.3/tinymce.min.js"></script>
<script>
tinymce.init({
  selector: '#summary, #content',
  plugins: 'lists link image table code',
  toolbar: 'undo redo | bold italic underline | bullist numlist | h2 h3 | link image | code',
  menubar: false,
  height: 300
});
</script>

<script>
// ---------- LOGIN ----------
async function hashString(str){
  const encoder=new TextEncoder();
  const data=encoder.encode(str);
  const hashBuffer=await crypto.subtle.digest('SHA-256',data);
  return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
const storedUsernameHash="8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; // admin
const storedPasswordHash="240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9"; // password
async function login(){
  const username=document.getElementById('username').value.trim();
  const password=document.getElementById('password').value.trim();
  const hashedUsername=await hashString(username);
  const hashedPassword=await hashString(password);
  if(hashedUsername===storedUsernameHash && hashedPassword===storedPasswordHash){
    document.getElementById('loginCard').style.display='none';
    document.getElementById('adminPanel').style.display='block';
    loadBlogs();
  } else document.getElementById('errorMsg').innerText='Invalid username or password';
}

// ---------- BLOG ADMIN ----------
const API_URL="https://akhiluthomas-website-backend.onrender.com/api/blogs";
let blogs=[];
let editId=null;
let currentPage=1;
const limit=6;
let totalPages=1;

async function loadBlogs(page=1){
  currentPage=page;
  try{
    const res=await fetch(`${API_URL}?page=${page}&limit=${limit}`);
    blogs=await res.json();

    const countRes=await fetch(`${API_URL}/count`);
    const { count }=await countRes.json();
    totalPages=Math.ceil(count/limit);

    renderAdminTable();
    renderPagination();
  }catch(err){console.error("Failed to load blogs:",err);}
}

function renderAdminTable(){
  const table=document.getElementById("blogAdminTable");
  table.innerHTML="";
  if(!blogs || blogs.length===0){
    table.innerHTML='<tr><td colspan="5" style="text-align:center;">No blogs found</td></tr>';
    return;
  }
  blogs.forEach((blog,i)=>{
    const date=new Date(blog.date).toLocaleDateString();
    table.innerHTML+=`
      <tr>
        <td>${(currentPage-1)*limit+i+1}</td>
        <td>${blog.title}</td>
        <td>${blog.author}</td>
        <td>${date}</td>
        <td>
          <button class="edit-btn" onclick="editBlog('${blog._id}')">Edit</button>
          <button class="delete-btn" onclick="deleteBlog('${blog._id}')">Delete</button>
        </td>
      </tr>
    `;
  });
}

function renderPagination(){
  const pagination=document.getElementById("pagination");
  pagination.innerHTML="";
  if(totalPages<=1) return;
  pagination.innerHTML+=`<button onclick="loadBlogs(${currentPage-1})" ${currentPage===1?"disabled":""}>Prev</button>`;
  for(let i=1;i<=totalPages;i++){
    pagination.innerHTML+=`<button onclick="loadBlogs(${i})" class="${i===currentPage?"active":""}">${i}</button>`;
  }
  pagination.innerHTML+=`<button onclick="loadBlogs(${currentPage+1})" ${currentPage===totalPages?"disabled":""}>Next</button>`;
}

function editBlog(id){
  const blog=blogs.find(b=>b._id===id);
  document.getElementById("title").value=blog.title;
  document.getElementById("author").value=blog.author;
  document.getElementById("date").value=new Date(blog.date).toISOString().split('T')[0];
  document.getElementById("image").value=blog.image;
  tinymce.get("summary").setContent(blog.summary||"");
  tinymce.get("content").setContent(blog.content||"");
  editId=id;
  document.getElementById("formTitle").innerText="Edit Blog";
  document.getElementById("submitBtn").innerText="Update Blog";
  document.getElementById("cancelEditBtn").style.display='inline-block';
}

document.getElementById("cancelEditBtn").addEventListener("click",function(){
  editId=null;
  document.getElementById("blogForm").reset();
  tinymce.get("summary").setContent("");
  tinymce.get("content").setContent("");
  document.getElementById("formTitle").innerText="Add New Blog";
  document.getElementById("submitBtn").innerText="Add Blog";
  this.style.display='none';
});

document.getElementById("blogForm").addEventListener("submit",async function(e){
  e.preventDefault();
  const summary=tinymce.get("summary").getContent().trim();
  const content=tinymce.get("content").getContent().trim();
  if(!summary||!content){
    alert("❌ Summary and Content cannot be empty!");
    return;
  }

  const blogData={
    title:document.getElementById("title").value.trim(),
    author:document.getElementById("author").value.trim(),
    date:document.getElementById("date").value,
    image:document.getElementById("image").value.trim(),
    summary,
    content
  };

  try{
    let res;
    if(editId===null){
      // CREATE: do NOT send slug (backend generates)
      res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(blogData)});
    } else {
      // UPDATE: backend regenerates slug only if title changed
      res=await fetch(`${API_URL}/${editId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(blogData)});
      editId=null;
      document.getElementById("formTitle").innerText="Add New Blog";
      document.getElementById("submitBtn").innerText="Add Blog";
      document.getElementById("cancelEditBtn").style.display='none';
    }
    const result=await res.json();
    if(!res.ok){alert("❌ Failed to save blog: "+(result.error||"Unknown error"));return;}
    alert("✅ "+result.message);
    this.reset();
    tinymce.get("summary").setContent("");
    tinymce.get("content").setContent("");
    loadBlogs(currentPage);
  }catch(err){console.error("Error submitting blog:",err);}
});

async function deleteBlog(id){
  if(confirm("Are you sure you want to delete this blog?")){
    try{
      const res=await fetch(`${API_URL}/${id}`,{method:"DELETE"});
      const result=await res.json();
      if(!res.ok){alert("❌ Failed to delete: "+(result.error||"Unknown error"));return;}
      alert("✅ "+result.message);
      loadBlogs(currentPage);
    }catch(err){console.error("Failed to delete blog:",err);}
  }
}
</script>
</body>
</html>
